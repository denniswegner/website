<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TLS analyzer</title>
    <!-- CSS Stylesheets -->
    <link rel="stylesheet" href="css/statistics.css">
    <link href="css/site.css" rel="stylesheet">
    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- Load c3.css -->
    <link href="js/c3-0.4.10/c3.css" rel="stylesheet" type="text/css">
    <!-- noUISlider c3.css -->
    <link rel="stylesheet" type="text/css" href="css/nouislider.min.css">
    <!-- jquery ui css -->
    <link rel="stylesheet" type="text/css" href="css/jquery-ui.css">
</head>

<body>
<!-- Use this for the new menuitems. If they are any changes just remember you should change the menu.js file into js-folder
    and the menu item will display dynamicly -->
    <nav id="nav01" class="navbar navbar-default navbar-fixed-top"></nav>

    <div class="container">
        <!-- Wrapper for padding-top 50x because of fixed nav bar -->
        <div class="content-wrapper">
            <div class="row">
              <div class="col-md-4">

                <div class="panel panel-default">
                  <div class="panel-heading">
                    <h3 class="panel-title">Select Chart</h3>
                </div>
                <div class="panel-body">
                    <!--Bootstrap Drop down menu for choosing charts -->
                    <div class="dropdown">
                        <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">Select a Chart
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
                            <li id="loadPFS"><a href="#">How many TLS Server support Perfect Forward Secrecy?</a></li>
                            <li id="loadDHEParameter"><a href="#">Diffie-Hellman Keygroups</a></li>
                            <li id="ciphersuites"><a href="#">Cipher Suites</a></li>
                            <li role="separator" class="divider"></li>
                            <li><a href="#">Separated link</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- Content will be loaded dynamically exterm html pages with .load() function -->
            <div id="dynamic"></div>

            <div class="panel panel-default">
              <div class="panel-heading">
                <h3 class="panel-title">Select Timespan (Slider)</h3>
            </div>
            <div class="panel-body">
               <!-- noUIslider -->
               Timespan:
               <div  id="slider-date"></div>
               <br>
               Start:<span id="event-start"></span><br>
               End:<span id="event-end"></span> <br><br>
               <button class="btn btn-default" onclick="applytimespan()" id="applytimespan">Apply Timespan</button>
           </div>
       </div>
       <!-- alternativly Date Picker (from jquery ui lib) -->
       <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">Select Timespan (Datepicker)</h3>
        </div>
        <div class="panel-body">
           <!-- jQuery ui Datepicker-->
           <label for="startDate">Start :</label>
           <input name="startDate" id="datepickerStart" class="date-picker" /><br>
           <label for="startDate">End :</label>
           <input name="startDate" id="datepickerEnd" class="date-picker" />
           <br><br>
           <button class="btn btn-default">Apply Timespan</button>
       </div>
   </div>

</div>

<!-- Graphs -->
<div class="col-md-8">
    <div class="panel panel-default">
      <div class="panel-body">

        <div id="charts">
            <!-- The charts are displayed here -->
            <div id="chart"></div>
            <!-- display next or previous chart -->
            <nav>
              <ul class="pager">
                <button id="previouschart" type="button" class="btn btn-default btn-lg">
                    <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                </button>
                <button id="nextchart" type="button" class="btn btn-default btn-lg">
                    <span  class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                </button>
            </ul>
        </nav>
    </div>
</div>
</div>

</div>


</div>
</div>
</div>
<footer id="footer"></footer>
<!-- Skripts are located in the end of the Body tag for faster Page Loading -->
<!-- for the menu -->
<script src="js/menu.js"></script>
<!-- Load d3.js and c3.js -->
<script src="js/c3-0.4.10/d3.min.js" charset="utf-8"></script>
<script src="js/c3-0.4.10/c3.min.js"></script>
<!-- JQuery CDN -->
<script src="js/jquery-1.11.3.min.js"></script>
<!-- Filter Menu -->
<script type="text/javascript" src="js/filterData.js"></script>
<!-- noUislider -->
<script type="text/javascript" src="js/nouislider.min.js"></script>
<!-- Bootstrap -->
<script src="js/bootstrap.min.js"></script>
<!-- Jquery ui -->
<script src="js/jquery-ui.min.js"></script>
<script>


        // Code will be executed  once the entire page (images or iframes), not just the DOM, is ready.
        window.onload = function () {



            // helper function for Timeslider
            function timestamp(str){
                return new Date(str).getTime();
            }

            // noUiSlider -> for selecting a timespan for displaying changes
            var dateSlider = document.getElementById('slider-date');

            noUiSlider.create(dateSlider, {
                connect: true,
                range: {
                 // Range is from where the project started to the current date
                 min: timestamp('2010-10-15'),
                 max: new Date().getTime()
             },
                // Steps of one month
                // (365.25d/y ) / 12 = 30,4375
                step: 30.4375 * 24 * 60 * 60 * 1000,

                // Two more timestamps indicate the handle starting positions.
                start: [ new Date().getTime(), new Date().getTime() ],
            });

            // Create a list of day and monthnames.
            var
            weekdays = [
            "Sunday", "Monday", "Tuesday",
            "Wednesday", "Thursday", "Friday",
            "Saturday"
            ],
            months = [
            "January", "February", "March",
            "April", "May", "June", "July",
            "August", "September", "October",
            "November", "December"
            ];

             // Create a string representation of the date.
             function formatDate ( date ) {
                return  date.getDate() + nth(date.getDate()) + " " +
                months[date.getMonth()] + " " +
                date.getFullYear();
            }


            // Span Elements -> The start and end values are displayed there
            var dateValues = [
            document.getElementById('event-start'),
            document.getElementById('event-end')
            ];

            // Update Handler -> Updates the span elements
            dateSlider.noUiSlider.on('update', function( values, handle ) {
                dateValues[handle].innerHTML = formatDate(new Date(+values[handle]));
            });


           // Append a suffix to dates.
           // Example: 23 => 23rd, 1 => 1st.
           function nth (d) {
              if(d>3 && d<21) return 'th';
              switch (d % 10) {
                case 1:  return "st";
                case 2:  return "nd";
                case 3:  return "rd";
                default: return "th";
            }
        }



            // Sample Data, this is ja required json format, that c3 requires
            var testdaten = {
                "dhe": [
                {
                    "keysize": "256",
                    "size": 3123,
                    "sizenew": 3320,
                    "percent": 0.5,

                },
                {
                    "keysize": "512",
                    "size": 31232,
                    "sizenew": 29000,
                    "percent": -0.4,
                },
                {
                    "keysize": "768",
                    "size": 6534,
                    "sizenew": 6203,
                    "percent": -0.1,
                },
                {
                    "keysize": "1024",
                    "size": 256434,
                    "sizenew": 270323,
                    "percent": 3,
                },
                {
                    "keysize": "2048",
                    "size": 65100,
                    "sizenew": 124303,
                    "percent": 50,
                },
                ],
                "pfs": [
                {
                    "PFS: ": "PFS enabled",
                    "amount": 80,
                },
                {
                    "PFS: ": "PFS disabled",
                    "amount": 80,
                }
                ]

            };

            var test_array_JSONs = [
            {"PFS enabled": 80, "PFS Disabled": 20},
            ];


            /*
             * All in one Chart.
             */
             var chart = c3.generate({
                bindto: '#chart',
                legend: {
                    show: true,
                },
                size: {
                    width: 640
                },
                data: {
                    labels: true,
                    type: 'bar',
                    json: testdaten.dhe,
                    keys: {
                        x: 'keysize',
                        value: ['size', 'sizenew', 'percent']
                    },
                    types: {
                        percent: 'line',
                    },
                    axes: {
                        'percent': 'y2'
                    },
                },
                axis: {
                    x: {
                        type: 'category',
                    },
                    y2: {
                        show: true,
                        label: {
                            text: 'In percent',
                            position: 'outer-middle'
                        },
                        max: 100,
                        min: 0
                    }
                },
                bar: {
                    width: {
                        ratio: 0.6
                    }
                },
            });

            /*
             * Load PFS-Pie-Chart function.
             */

             $.ajaxSetup({
                timeout: 2000
            });


             $("#loadPFS").click(function ()
             {
                // Load data from the server using a HTTP GET request
                // jquery.get is a equivalent to $.ajax({....
                    jQuery.get( "http://tls.thejetlag.de:1337/api/v0/pfs/overview", function( response ) { 
                        chart.load({
                            json: response,
                            keys: {
                                value: ['pfsEnabled', 'pfsDisabled']
                            },
                            type: 'pie',
                            unload: chart.columns,
                        });
                    } ).error(function() {
                        alert( "Error Loading JSON" );
                        chart.load({
                            json: test_array_JSONs,
                            keys: {
                                value: ['PFS enabled', 'PFS Disabled']
                            },
                            type: 'pie',
                            unload: chart.columns,
                        });
                    });

                    // empty all elements within the div tag with id dynamic
                    $("#dynamic").empty();
                    $("#dropdownMenu1").html('How many Server supports Perfect Forward Secrecy? <span class="caret"></span>');
                }
                );


             // This is called when the reload button is clicked!
             $("#applytimespan").click(function ()
             {
                // Check if start and end values of the slieder are the same
                var start = dateSlider.noUiSlider.get();
                // If yes then get normal Json
                if (start[0] == start[1]) {
                  alert("Not Yet implemented");
              }
               // Otherwise get the two differen json objects, compare, and make a chart
               else{
                alert("Not Yet implemented");
            }
        }
        );


            /*
             * Load DHE-Parameter-Chart function with one Y-Axis.
             */

             $("#loadDHEParameter").click(function ()
             {

                // Load data from the server using a HTTP GET request
                // jquery.get is a equivalent to $.ajax({....
                    jQuery.get( "http://tls.thejetlag.de:1337/api/v0/pfs/distribution", function( response ) { 
                        chart.load({
                            type: 'bar',
                            json: response[0].distribution,
                            keys: {
                                x: 'kx',
                                value: ['count', 'kxStrength']
                            },
                            unload: chart.columns,
                        });
                    } ).error(function() {
                        alert( "Error Loading JSON" );
                        chart.load({
                            type: 'bar',
                            json: testdaten.dhe,
                            keys: {
                                x: 'keysize',
                                value: ['size']
                            },
                            unload: chart.columns,
                        });
                    });

                // takes the dynamic div tag out of the DOM
                $("#dynamic").empty();
                $("#dropdownMenu1").html('Diffie-Hellman Keygroups <span class="caret"></span>');
            }
            );

            /*
             * Load Cipher Suites Chart
             */

             $("#ciphersuites").click(function ()
             {
               chart.load({
                unload: chart.columns,
            });
               $("#dynamic").load("filterciphers.html");
               $("#dropdownMenu1").html('Cipher Suites <span class="caret"></span>');

           }
           );

             var globalChartNumber = 1;



             function loadChartbyNumber(number){

                switch(number){
                    case 1:
                    $( "#loadPFS" ).trigger( "click" );
                    globalChartNumber = 1;
                    break;
                    case 2:
                    $( "#loadDHEParameter" ).trigger( "click" );
                    globalChartNumber = 2;
                    break;
                    case 3:
                    $( "#ciphersuites" ).trigger( "click" );
                    globalChartNumber = 3;
                    break;
                    default:
                    alert("Problem with loading Chart");
                }
            }




            /*
            * randomly load a chart
            */

            var random = Math.floor((Math.random() * 3) + 1); 
            loadChartbyNumber(random);

            /*
            * Select previous or next chart by decreasing or increasing the globalnumber
            */

            $("#previouschart").click(function ()
            {
              globalChartNumber--;
              if (globalChartNumber <= 0 ) {
                globalChartNumber = 1;
                return;
            };
            loadChartbyNumber(globalChartNumber);

        }
        );

            $("#nextchart").click(function ()
            {
                globalChartNumber++;
                if (globalChartNumber > 3 ) {
                    globalChartNumber = 3;
                    return;
                };
                loadChartbyNumber(globalChartNumber);

            }
            );

            // !! The following charts are only for test purposes !!
            // Second chart with multidimensinonal Array. I didn't figure out how we can use the additional y-axis
            // in the first chart

            var charty2 = c3.generate({
                bindto: '#charty2',
                size: {
                    width: 640
                },
                data: {
                    columns: [
                    ['key-size', 634, 21254, 1432, 253542, 11343, 132543],
                    ['percent', 1, 10, 2, 80, 6, 20],
                    ],
                    type: 'bar',
                    types: {
                        percent: 'line',
                    },
                    axes: {
                        'percent': 'y2'
                    },
                },
                axis: {
                    x: {
                        type: 'category',
                        categories: ['256', '512', '768', '1024', '1536', '2048']
                    },
                    y: {
                        label: {
                            text: 'Counts',
                            position: 'outer-middle'
                        }
                    },
                    y2: {
                        show: true,
                        label: {
                            text: 'In percent',
                            position: 'outer-middle'
                        },
                        max: 100,
                        min: 0
                    }
                }


            });


var donutChart = c3.generate({
    bindto: '#pie',
    data: {
        json: test_array_JSONs,
        keys: {
            value: ['PFS enabled', 'PFS Disabled']
        },
        type: 'pie'
    }
});

$('#datepickerStart').datepicker(
{
    dateFormat: "mm/yy",
    changeMonth: true,
    changeYear: true,
    showButtonPanel: true,
    onClose: function(dateText, inst) {


        function isDonePressed(){
            return ($('#ui-datepicker-div').html().indexOf('ui-datepicker-close ui-state-default ui-priority-primary ui-corner-all ui-state-hover') > -1);
        }

        if (isDonePressed()){
            var month = $("#ui-datepicker-div .ui-datepicker-month :selected").val();
            var year = $("#ui-datepicker-div .ui-datepicker-year :selected").val();
            $(this).datepicker('setDate', new Date(year, month, 1)).trigger('change');

                                 $('.date-picker').focusout()//Added to remove focus from datepicker input box on selecting date
                             }
                         },
                         beforeShow : function(input, inst) {

                            inst.dpDiv.addClass('month_year_datepicker')

                            if ((datestr = $(this).val()).length > 0) {
                                year = datestr.substring(datestr.length-4, datestr.length);
                                month = datestr.substring(0, 2);
                                $(this).datepicker('option', 'defaultDate', new Date(year, month-1, 1));
                                $(this).datepicker('setDate', new Date(year, month-1, 1));
                                $(".ui-datepicker-calendar").hide();
                            }
                        }
                    });


$('#datepickerEnd').datepicker(
{
    dateFormat: "mm/yy",
    changeMonth: true,
    changeYear: true,
    showButtonPanel: true,
    onClose: function(dateText, inst) {


        function isDonePressed(){
            return ($('#ui-datepicker-div').html().indexOf('ui-datepicker-close ui-state-default ui-priority-primary ui-corner-all ui-state-hover') > -1);
        }

        if (isDonePressed()){
            var month = $("#ui-datepicker-div .ui-datepicker-month :selected").val();
            var year = $("#ui-datepicker-div .ui-datepicker-year :selected").val();
            $(this).datepicker('setDate', new Date(year, month, 1)).trigger('change');

                                 $('.date-picker').focusout()//Added to remove focus from datepicker input box on selecting date
                             }
                         },
                         beforeShow : function(input, inst) {

                            inst.dpDiv.addClass('month_year_datepicker')

                            if ((datestr = $(this).val()).length > 0) {
                                year = datestr.substring(datestr.length-4, datestr.length);
                                month = datestr.substring(0, 2);
                                $(this).datepicker('option', 'defaultDate', new Date(year, month-1, 1));
                                $(this).datepicker('setDate', new Date(year, month-1, 1));
                                $(".ui-datepicker-calendar").hide();
                            }
                        }
                    });


};
</script>

</body>
</html>
